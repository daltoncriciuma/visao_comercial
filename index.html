<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Visão Comercial</title>
<style>
  :root { color-scheme: dark; }
  html, body {
    margin:0; width:100vw; height:100vh; overflow:hidden;
    background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* A peça fica sempre ancorada no centro da janela */
  .box{
    position:fixed; left:50%; top:50%;
    width:768px; height:1152px;             /* base 2:3 */
    transform-origin:50% 50%;
    will-change: transform;
  }
  svg{ width:100%; height:100%; display:block; }

  /* HUD */
  .hud{
    position:fixed; right:12px; bottom:12px; display:flex; gap:10px; align-items:center;
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.15);
    padding:8px 12px; border-radius:12px; font-size:14px; backdrop-filter:blur(4px);
  }
  .btn{ cursor:pointer; border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.08); padding:6px 10px; border-radius:8px; font-weight:600; }
  .btn:hover{ background:rgba(255,255,255,.15); }
  .muted{ opacity:.8 }
</style>
</head>
<body>

  <!-- A peça (sempre centralizada) -->
  <div class="box" id="box">
    <svg viewBox="0 0 768 1152" aria-label="Medidor">
      <defs>
        <!-- Caminho do frasco (usado para contorno e recorte) -->
        <path id="bottlePath"
          d="M260 170 H508 L532 300
             L592 1000
             Q592 1088 384 1125
             Q176 1088 176 1000
             L236 300 Z"/>
        <clipPath id="clipBottle"><use href="#bottlePath"/></clipPath>
        <linearGradient id="liq" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%"  stop-color="#6bb8ff"/>
          <stop offset="100%" stop-color="#1976d2"/>
        </linearGradient>
      </defs>

      <!-- Líquido (recortado pelo frasco) -->
      <g clip-path="url(#clipBottle)">
        <rect id="liquid" x="0" y="1125" width="768" height="0" fill="url(#liq)"/>
        <rect id="shine"  x="0" y="1125" width="768" height="8" fill="rgba(255,255,255,.45)"/>
      </g>

      <!-- Contorno -->
      <use href="#bottlePath" fill="none" stroke="#cfe8ff" stroke-width="8"
           filter="drop-shadow(0 10px 30px rgba(25,118,210,.25))"/>

      <!-- Rótulos -->
      <text id="labelTop" x="384" y="145"
            text-anchor="middle" font-size="28" font-weight="800" fill="#fff">30</text>
      <text id="labelPct" x="730" y="600"
            text-anchor="end" font-size="22" font-weight="800" fill="#fff">0%</text>
      <text id="labelPts" x="384" y="900"
            text-anchor="middle" font-size="34" font-weight="800" fill="#fff">0,00</text>
    </svg>
  </div>

  <!-- HUD -->
  <div class="hud">
    <button class="btn" id="zoomOut">−</button>
    <button class="btn" id="zoomReset">100%</button>
    <button class="btn" id="zoomIn">+</button>
    <button class="btn" id="reloadBtn">Recarregar</button>
    <span class="muted" id="stamp">—</span>
  </div>

<script>
  /* ===== CONFIG ===== */
  // CSV (gid=256356509), valor 0..1 em A1
  const DATA_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vR24Vx4SCLyGxtnD8X0tYOnBIZJ_Y10BYhYwaESp2Sui60TTEgC13hvPO8vKNtiMYp35L-A9LcGNmHB/pub?gid=256356509&output=csv";

  const PONTOS_MAX = 30;
  const AUTO_RELOAD_MIN = 5;     // 0 = desliga auto
  const PERCENT_DEFAULT = 0.446; // fallback
  const BASE_W = 768, BASE_H = 1152;

  // **Ajuste fino vertical** (em % da altura da janela): negativo = sobe
  const BIAS_VH = -6; // tente -6 (sobe), -8 (sobe mais) ou 0 (centro exato)

  // ===== centro + zoom =====
  let userZoom = 1.00, ZOOM_STEP = 0.08;
  function fit(){
    const vw = window.innerWidth, vh = window.innerHeight;
    const k  = Math.min(vw/BASE_W, vh/BASE_H) * userZoom;
    const biasPx = (BIAS_VH/100) * vh; // deslocamento vertical opcional
    // Centraliza matematicamente e aplica o deslocamento (pra cima/baixo)
    document.getElementById('box').style.transform =
      `translate(-50%, -50%) translateY(${biasPx}px) scale(${k})`;
    document.getElementById('zoomReset').textContent = Math.round(userZoom*100)+'%';
  }
  function zoomIn(){ userZoom = Math.min(2.5, +(userZoom+ZOOM_STEP).toFixed(2)); fit(); }
  function zoomOut(){ userZoom = Math.max(0.5, +(userZoom-ZOOM_STEP).toFixed(2)); fit(); }
  function zoomReset(){ userZoom = 1.00; fit(); }
  window.addEventListener('resize', fit);
  document.getElementById('zoomIn').onclick  = zoomIn;
  document.getElementById('zoomOut').onclick = zoomOut;
  document.getElementById('zoomReset').onclick = zoomReset;
  document.getElementById('reloadBtn').onclick = load;
  window.addEventListener('keydown', e=>{
    if(e.key==='+') zoomIn();
    if(e.key==='-'||e.key==='−') zoomOut();
    if(e.key==='0') zoomReset();
    if(e.key.toLowerCase()==='r') load();
  });

  // ===== CSV → percentual =====
  async function fetchPercent(){
    try{
      const url = DATA_CSV_URL + (DATA_CSV_URL.includes('?')?'&':'?') + 'cb=' + Date.now();
      const txt = await fetch(url).then(r=>r.text());
      const m = txt.match(/-?\d+(?:[.,]\d+)?/);
      const n = m ? parseFloat(m[0].replace(',','.')) : NaN;
      if (isFinite(n)) return Math.max(0, Math.min(1, n));
    }catch(_){}
    return null;
  }

  // ===== atualiza desenho =====
  const TOP_Y = 300, BOT_Y = 1125; // corpo do frasco
  function setLevel(p){
    p = Math.max(0, Math.min(1, p));
    const yTop = BOT_Y - (BOT_Y - TOP_Y) * p;
    const h    = BOT_Y - yTop;

    const liq = document.getElementById('liquid');
    const shine = document.getElementById('shine');
    liq.setAttribute('y', yTop);  liq.setAttribute('height', h);
    shine.setAttribute('y', yTop);

    // pontos (centro do azul)
    const pts = (p*PONTOS_MAX).toFixed(2).replace('.', ',');
    const lblPts = document.getElementById('labelPts');
    lblPts.textContent = pts;
    lblPts.setAttribute('y', yTop + h/2);

    // topo
    document.getElementById('labelTop').textContent = PONTOS_MAX;

    // % na linha d’água
    const pct = (p*100).toFixed(2).replace('.', ',') + '%';
    const lblPct = document.getElementById('labelPct');
    lblPct.textContent = pct;
    lblPct.setAttribute('y', yTop - 10);

    // carimbo
    const n=new Date(), two=x=>String(x).padStart(2,'0');
    document.getElementById('stamp').textContent =
      `Atualizado: ${two(n.getHours())}:${two(n.getMinutes())}`;
  }

  async function load(){
    const p = await fetchPercent();
    setLevel(p==null ? PERCENT_DEFAULT : p);
  }

  // start
  fit(); load();
  if (AUTO_RELOAD_MIN>0) setInterval(load, AUTO_RELOAD_MIN*60*1000);
</script>
</body>
</html>
